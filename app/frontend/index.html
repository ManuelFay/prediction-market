<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Friends Prediction Market</title>
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #0b1021;
        color: #e2e8f0;
      }
      body {
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.08), transparent 30%),
          radial-gradient(circle at bottom right, rgba(16, 185, 129, 0.08), transparent 25%),
          #0b1021;
      }
      header {
        background: #0f172a;
        padding: 18px 24px;
        border-bottom: 1px solid #1f2937;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        position: sticky;
        top: 0;
        z-index: 10;
      }
      h1 {
        margin: 0;
        font-size: 22px;
      }
      main {
        padding: 20px 24px 32px;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 16px;
        align-items: start;
      }
      section {
        background: transparent;
        border: none;
        padding: 0;
      }
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .surface {
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid #1f2937;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
      }
      .panel.elevated {
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        background: linear-gradient(160deg, rgba(17, 24, 39, 0.9), rgba(30, 41, 59, 0.85));
      }
      .panel.soft {
        background: rgba(17, 24, 39, 0.65);
        border-color: #1f2937;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        background: linear-gradient(90deg, #14b8a6, #2563eb);
        color: #0b1021;
        font-weight: 700;
        border: 1px solid #38bdf8;
      }
      .chip.ghost {
        background: #0b1221;
        color: #e2e8f0;
        border-color: #1f2937;
      }
      #app-shell.hidden {
        display: none;
      }
      h2 {
        margin-top: 0;
        font-size: 18px;
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }
      input,
      select,
      textarea,
      button {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 10px;
        border: 1px solid #1f2937;
        background: #0b1221;
        color: #e2e8f0;
        box-sizing: border-box;
      }
      button {
        cursor: pointer;
        background: linear-gradient(90deg, #14b8a6, #3b82f6);
        border: none;
        font-weight: 700;
        transition: transform 0.08s ease, box-shadow 0.08s ease;
        text-align: left;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.25);
      }
      button.secondary {
        background: #111827;
        border: 1px solid #334155;
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
        margin-bottom: 10px;
      }
      .metric {
        background: #0b1221;
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 10px;
      }
      .metric .label {
        color: #94a3b8;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .metric .value {
        font-size: 18px;
        font-weight: 700;
      }
      .market-card {
        display: grid;
        gap: 8px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #1f2937;
        background: #0b1221;
        margin-bottom: 12px;
      }
      .market-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
      }
      .bets-list,
      .ledger-list {
        max-height: 260px;
        overflow: auto;
        border: 1px solid #1f2937;
        border-radius: 10px;
      }
      .list-row {
        border-bottom: 1px solid #1f2937;
        padding: 8px 10px;
      }
      .list-row:last-child {
        border-bottom: none;
      }
      .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        background: #1f2937;
        border: 1px solid #334155;
        margin-right: 6px;
      }
      .pill {
        padding: 2px 8px;
        border-radius: 8px;
        background: #1e3a8a;
        display: inline-block;
      }
      .danger {
        background: #7f1d1d;
        border: 1px solid #dc2626;
      }
      .success {
        background: #064e3b;
        border: 1px solid #10b981;
      }
      .button-sub {
        display: block;
        font-weight: 500;
        font-size: 12px;
        opacity: 0.9;
      }
      .small {
        font-size: 12px;
        color: #94a3b8;
      }
      .flex {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .flex-between {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .chart {
        background: #0b1221;
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 10px;
      }
      .warning {
        background: #3f1f1f;
        border: 1px solid #7f1d1d;
        padding: 8px 10px;
        border-radius: 8px;
        color: #fecaca;
      }
      .muted {
        color: #94a3b8;
        font-size: 12px;
      }
      .tab-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px;
        margin-bottom: 8px;
      }
      .tab-button {
        background: #111827;
        border: 1px solid #1f2937;
        color: #e2e8f0;
      }
      .tab-button.active {
        background: linear-gradient(90deg, #0ea5e9, #6366f1);
        border-color: #1d4ed8;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .detail-grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      .panel {
        border: 1px solid #1f2937;
        background: #0c1326;
        border-radius: 12px;
        padding: 12px;
      }
      .inline-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .inline-group > input,
      .inline-group > button {
        width: auto;
        flex: 1;
      }
      .inline-group > button {
        flex: 0 0 auto;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Friends-only Prediction Market</h1>
    </header>
    <main>
      <section class="sidebar">
        <div class="panel elevated">
          <div class="flex-between">
            <div>
              <h2>Log in</h2>
              <div class="muted">Sign in with your username to unlock the market.</div>
            </div>
            <span class="chip" id="session-chip">Offline</span>
          </div>
          <label for="backend-url">Backend URL</label>
          <input id="backend-url" placeholder="https://my-market.example.com" />
          <div class="inline-group">
            <button class="secondary" onclick="applyBackendUrl()">Connect</button>
            <button class="secondary" onclick="refreshData()">Refresh</button>
          </div>
          <label for="login-username">Username</label>
          <input id="login-username" placeholder="e.g. Alice" />
          <label for="login-password">Password</label>
          <input id="login-password" type="password" placeholder="Paste your password" />
          <div class="inline-group">
            <button onclick="loginUser()">Start session</button>
            <button class="secondary" id="logout-btn" onclick="logoutSession()" disabled>Log out</button>
          </div>
          <div class="muted" id="session-status">Waiting for login.</div>
          <div class="metrics hidden" id="session-metrics">
            <div class="metric">
              <div class="label">Balance</div>
              <div class="value" id="balance">–</div>
            </div>
            <div class="metric">
              <div class="label">Positions</div>
              <div class="value" id="positions-count">–</div>
            </div>
          </div>
            <div class="panel soft hidden" id="active-account">
            <div class="label">Active account</div>
            <div class="value" id="active-user-name">–</div>
            <div class="small" id="share-link"></div>
          </div>
        </div>
        <div class="panel elevated">
          <div class="flex-between">
            <div>
              <h3>Admin console</h3>
              <div class="muted">Manage users and share credentials.</div>
            </div>
            <span class="chip ghost" id="admin-chip">Locked</span>
          </div>
          <div class="muted" id="admin-status">Log in as admin/admin in the main form to unlock controls.</div>
          <div class="inline-group">
            <button class="secondary" id="admin-logout" onclick="logoutAdmin()" disabled>Log out admin</button>
          </div>
          <div id="admin-actions" class="hidden">
            <div class="inline-group">
              <input id="new-user-name" placeholder="New user name" />
              <button onclick="createUser()">Create user</button>
            </div>
            <div class="small">New users start with 50€ and a fresh password.</div>
            <div id="password-display" class="warning hidden"></div>
            <label for="admin-user-target">Manage user</label>
            <select id="admin-user-target"></select>
            <div class="small">Applies to balance updates and deletions.</div>
            <div class="panel soft">
              <div class="flex-between">
                <div>
                  <div class="label">Balances</div>
                  <div class="small">Top up the selected account directly.</div>
                </div>
                <input id="topup-amount" type="number" step="1" value="10" />
              </div>
              <div class="inline-group">
                <button class="secondary" onclick="deposit()">Top up selected user</button>
                <button class="secondary danger" onclick="deleteActiveUser()">Delete selected user</button>
              </div>
            </div>
            <div class="panel soft">
              <div class="flex-between">
                <div>
                  <div class="label">Platform</div>
                  <div class="small">Maintenance tools</div>
                </div>
                <button class="secondary danger" onclick="resetPlatform()">Reset platform</button>
              </div>
            </div>
            <h4>User directory</h4>
            <div class="ledger-list" id="admin-directory"></div>
          </div>
        </div>
      </section>
      <section id="app-shell" class="hidden">
        <div class="surface">
          <div class="tab-bar">
            <button class="tab-button active" id="tab-open-btn" onclick="switchTab('open')">Open markets</button>
            <button class="tab-button" id="tab-admin-btn" onclick="switchTab('admin')">Market admin</button>
          </div>
          <div id="tab-open" class="tab-content active">
            <div class="flex-between">
              <div>
                <div class="label">Active account</div>
                <div class="value" id="menu-user-name">–</div>
              </div>
              <button class="secondary" id="create-toggle" onclick="toggleCreateForm()">Create new market</button>
            </div>
            <div id="create-panel" class="panel hidden">
              <div class="flex-between small"><span>Seed: 10€ will be locked from creator.</span><span>Bet size: fixed 1€</span></div>
              <label for="question">Question</label>
              <input id="question" placeholder="YES if PSG beats OM?" />
              <label for="description">Details</label>
              <textarea id="description" placeholder="Resolution rules, notes"></textarea>
              <label for="initial-prob">Initial probability for YES (0-1)</label>
              <input id="initial-prob" type="number" step="0.01" value="0.5" />
              <label for="liquidity-b">Liquidity b (controls slippage)</label>
              <input id="liquidity-b" type="number" step="0.5" value="5" />
              <button onclick="createMarket()">Create market</button>
            </div>
            <div id="open-markets"></div>
            <div id="market-detail" class="panel"><div class="muted">Select a market to see details</div></div>
          </div>
          <div id="tab-admin" class="tab-content">
            <h2>Market admin</h2>
            <div class="muted">Manage the markets you created. You can resolve, delete or open their details.</div>
            <div id="admin-markets"></div>
          </div>
        </div>
        <div class="panel elevated">
          <div class="flex-between">
            <h3>Open positions</h3>
            <span class="chip ghost" id="positions-chip">0</span>
          </div>
          <div class="bets-list" id="positions"></div>
        </div>
        <div class="panel elevated">
          <div class="flex-between">
            <h3>Ledger</h3>
            <span class="chip ghost" id="balance-chip">–</span>
          </div>
          <div class="ledger-list" id="ledger"></div>
        </div>
      </section>
    </main>
    <script>
      const storedBackend = localStorage.getItem('apiBase');
      let apiBase = (storedBackend || window.location.origin).replace(/\/$/, '');
      let users = [];
      let markets = [];
      let selectedMarket = null;
      const loadActiveUserFromStorage = () => {
        const sessionId = Number(sessionStorage.getItem('activeUserId') || '') || null;
        const sessionName = sessionStorage.getItem('activeUserName') || '';
        if (sessionId) return { id: sessionId, name: sessionName };

        const legacyId = Number(localStorage.getItem('activeUserId') || '') || null;
        const legacyName = localStorage.getItem('activeUserName') || '';
        if (legacyId) {
          sessionStorage.setItem('activeUserId', String(legacyId));
          sessionStorage.setItem('activeUserName', legacyName);
          return { id: legacyId, name: legacyName };
        }

        return { id: null, name: '' };
      };

      const initialActiveUser = loadActiveUserFromStorage();
      let activeUserId = initialActiveUser.id;
      let activeUserName = initialActiveUser.name;
      let savedPasswords = JSON.parse(localStorage.getItem('userPasswords') || '{}');
      let createFormOpen = false;
      let adminSession = { username: '', password: '', authenticated: false };
      let adminDirectory = [];
      const initialUserFromQuery = Number(new URLSearchParams(window.location.search).get('user_id') || '');

      function applyBackendUrl() {
        const input = document.getElementById('backend-url');
        const value = (input.value || '').trim().replace(/\/$/, '');
        if (!value) return alert('Enter a backend URL');
        apiBase = value;
        localStorage.setItem('apiBase', apiBase);
        refreshData();
      }

      function updateBackendInput() {
        const input = document.getElementById('backend-url');
        if (input) input.value = apiBase;
      }

      function switchTab(tab) {
        document.querySelectorAll('.tab-button').forEach((btn) => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));
        document.getElementById(`tab-${tab}-btn`).classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
      }

      function persistPasswords() {
        localStorage.setItem('userPasswords', JSON.stringify(savedPasswords));
      }

      function getUserPassword(userId) {
        return userId ? savedPasswords[userId] || '' : '';
      }

      function setUserPassword(userId, password) {
        if (!userId || !password) return;
        savedPasswords[userId] = password;
        persistPasswords();
      }

      function adminHeaders() {
        if (!adminSession.authenticated) return {};
        const token = btoa(`${adminSession.username}:${adminSession.password}`);
        return { Authorization: `Basic ${token}` };
      }

      function ensureAdmin() {
        if (!adminSession.authenticated) {
          alert('Admin login required for this action.');
          return false;
        }
        return true;
      }

      function getAdminSelectedUserId() {
        const select = document.getElementById('admin-user-target');
        return select ? Number(select.value) || null : null;
      }

      function renderAdminUserSelect() {
        const select = document.getElementById('admin-user-target');
        if (!select) return;
        const options = ['<option value="">Select user</option>'];
        users.forEach((u) => options.push(`<option value="${u.id}">${u.name} (ID ${u.id})</option>`));
        select.innerHTML = options.join('');
      }

      function setAdminSelectedUser(userId) {
        const select = document.getElementById('admin-user-target');
        if (!select) return;
        select.value = userId ? String(userId) : '';
      }

      async function loginUser() {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value.trim();
        if (!username || !password) return alert('Enter both username and password.');
        const isAdmin = username.toLowerCase() === 'admin' && password === 'admin';
        if (isAdmin) {
          logoutUser(false);
          adminSession = { username, password, authenticated: true };
          updateAdminStatus();
          document.getElementById('session-status').textContent = 'Admin session active. User access disabled.';
          alert('Admin controls unlocked.');
          await refreshActiveUser();
          switchTab('admin');
          return;
        }
        logoutAdmin();
        const user = users.find((u) => u.name.toLowerCase() === username.toLowerCase());
        if (!user) return alert('No user found with that username. Ask the admin to create an account.');
        setUserPassword(user.id, password);
        setActiveUser(user);
        renderSessionHeader();
      }

      function logoutUser(updateUi = true) {
        activeUserId = null;
        activeUserName = '';
        sessionStorage.removeItem('activeUserId');
        sessionStorage.removeItem('activeUserName');
        document.getElementById('login-password').value = '';
        renderSessionHeader();
        if (updateUi) refreshActiveUser();
      }

      function logoutAdmin() {
        adminSession = { username: '', password: '', authenticated: false };
        updateAdminStatus();
        refreshActiveUser();
      }

      function logoutSession() {
        logoutAdmin();
        logoutUser();
      }

      function updateAdminStatus() {
        const statusBox = document.getElementById('admin-status');
        const actions = document.getElementById('admin-actions');
        const chip = document.getElementById('admin-chip');
        const logoutButton = document.getElementById('admin-logout');
        if (adminSession.authenticated) {
          if (statusBox) statusBox.textContent = `Admin unlocked as ${adminSession.username}.`;
          if (actions) actions.classList.remove('hidden');
          if (chip) {
            chip.textContent = 'Admin online';
            chip.classList.remove('ghost');
          }
          if (logoutButton) logoutButton.disabled = false;
          loadAdminDirectory();
        } else {
          if (statusBox) statusBox.textContent = 'Log in as admin/admin in the main form to unlock controls.';
          if (actions) actions.classList.add('hidden');
          if (chip) {
            chip.textContent = 'Locked';
            chip.classList.add('ghost');
          }
          if (logoutButton) logoutButton.disabled = true;
          adminDirectory = [];
          renderAdminDirectory();
        }
      }

      function isUserAuthenticated(userId = getActiveUserId()) {
        if (adminSession.authenticated) return false;
        return Boolean(userId && getUserPassword(userId));
      }

      function renderSessionHeader() {
        const chip = document.getElementById('session-chip');
        const metrics = document.getElementById('session-metrics');
        if (!chip) return;
        if (adminSession.authenticated) {
          chip.textContent = 'Admin session';
          chip.classList.remove('ghost');
          metrics?.classList.add('hidden');
          return;
        }
        if (activeUserId) {
          const name = activeUserName || userName(activeUserId);
          chip.textContent = `Logged in as ${name}`;
          chip.classList.remove('ghost');
          metrics?.classList.remove('hidden');
        } else {
          chip.textContent = 'Offline';
          chip.classList.add('ghost');
          metrics?.classList.add('hidden');
        }
      }

      function renderAdminDirectory() {
        const container = document.getElementById('admin-directory');
        if (!container) return;
        if (!adminSession.authenticated) {
          container.innerHTML = '<div class="muted">Log in as admin to view user credentials.</div>';
          return;
        }
        if (!adminDirectory.length) {
          container.innerHTML = '<div class="muted">No users yet. Create one to share credentials.</div>';
          return;
        }
        container.innerHTML = adminDirectory
          .map(
            (u) => `
              <div class="list-row small">
                <div class="flex-between"><strong>${u.name}</strong><span>ID ${u.id}</span></div>
                <div>Balance: ${u.balance.toFixed(2)}€</div>
                <div>Password: <span class="pill">${u.password}</span></div>
              </div>
            `,
          )
          .join('');
      }

      async function loadAdminDirectory() {
        if (!adminSession.authenticated) return;
        try {
          adminDirectory = await fetchJSON('/admin/users', { headers: adminHeaders() });
        } catch (err) {
          adminDirectory = [];
          alert(err.message || 'Could not load admin directory');
        }
        renderAdminDirectory();
      }

      function revealPassword(user) {
        const box = document.getElementById('password-display');
        if (!box) return;
        box.textContent = `Password for ${user.name}: ${user.password}`;
        box.classList.remove('hidden');
      }

      async function fetchJSON(path, options = {}) {
        const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
        const res = await fetch(`${apiBase}${path}`, {
          ...options,
          headers,
        });
        if (!res.ok) {
          const error = await res.json().catch(() => ({}));
          throw new Error(error.detail || 'Request failed');
        }
        if (res.status === 204) return {};
        return res.json();
      }

      async function createUser() {
        if (!ensureAdmin()) return;
        const name = document.getElementById('new-user-name').value.trim();
        if (!name) return alert('Enter a name');
        let user;
        try {
          user = await fetchJSON('/users', { method: 'POST', headers: adminHeaders(), body: JSON.stringify({ name }) });
        } catch (err) {
          alert(err.message || 'User creation failed');
          return;
        }
        document.getElementById('new-user-name').value = '';
        revealPassword(user);
        setUserPassword(user.id, user.password);
        await loadUsers();
        renderAdminUserSelect();
        setAdminSelectedUser(user.id);
        setActiveUser(user);
        await loadAdminDirectory();
      }

      async function resetPlatform() {
        if (!ensureAdmin()) return;
        if (!confirm('This will delete all users, markets, and bets. Continue?')) return;
        try {
          await fetchJSON('/reset', { method: 'POST', headers: adminHeaders() });
        } catch (err) {
          alert(err.message || 'Reset failed');
          return;
        }
        document.getElementById('balance').textContent = '–';
        document.getElementById('positions-count').textContent = '–';
        document.getElementById('ledger').innerHTML = '';
        document.getElementById('positions').innerHTML = '';
        selectedMarket = null;
        setActiveUser(null);
        await loadUsers();
        await loadMarkets();
      }

      async function deposit() {
        if (!ensureAdmin()) return;
        const userId = getAdminSelectedUserId();
        if (!userId) return alert('Select a user to top up.');
        const amount = Number(document.getElementById('topup-amount').value || '0');
        if (amount <= 0) return alert('Enter a positive amount');
        try {
          await fetchJSON(`/users/${userId}/deposit`, {
            method: 'POST',
            headers: adminHeaders(),
            body: JSON.stringify({ amount }),
          });
        } catch (err) {
          alert(err.message || 'Top-up failed');
          return;
        }
        await loadUsers();
        await refreshActiveUser();
      }

      async function deleteActiveUser() {
        if (!ensureAdmin()) return;
        const userId = getAdminSelectedUserId();
        if (!userId) return alert('Pick a user to delete.');
        if (!confirm('Delete this user account? Markets must be cleared and no bets outstanding.')) return;
        try {
          await fetchJSON(`/users/${userId}`, { method: 'DELETE', headers: adminHeaders() });
        } catch (err) {
          alert(err.message || 'Delete failed');
          return;
        }
        document.getElementById('balance').textContent = '–';
        document.getElementById('positions-count').textContent = '–';
        setActiveUser(null);
        await loadUsers();
        renderAdminUserSelect();
      }

      function toggleCreateForm() {
        const userId = getActiveUserId();
        if (!userId) return alert('Log in to create a market.');
        createFormOpen = !createFormOpen;
        document.getElementById('create-panel').classList.toggle('hidden', !createFormOpen);
        document.getElementById('create-toggle').textContent = createFormOpen ? 'Hide market form' : 'Create new market';
        if (createFormOpen) {
          document.getElementById('create-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      async function createMarket() {
        const userId = getActiveUserId();
        if (!userId) return alert('Log in to create a market.');
        const payload = {
          question: document.getElementById('question').value,
          description: document.getElementById('description').value,
          initial_prob_yes: Number(document.getElementById('initial-prob').value),
          liquidity_b: Number(document.getElementById('liquidity-b').value),
        };
        await fetchJSON(`/markets?user_id=${userId}`, { method: 'POST', body: JSON.stringify(payload) });
        document.getElementById('question').value = '';
        document.getElementById('description').value = '';
        createFormOpen = false;
        document.getElementById('create-panel').classList.add('hidden');
        document.getElementById('create-toggle').textContent = 'Create new market';
        await loadMarkets();
        await refreshActiveUser();
        switchTab('open');
      }

      async function placeBet(marketId, side) {
        const userId = getActiveUserId();
        if (!userId) return alert('Log in to place bets.');
        const password = getUserPassword(userId);
        if (!password) return alert('Enter the account password to place bets.');
        try {
          await ensureOddsInSync(marketId);
          await fetchJSON(`/markets/${marketId}/bet?user_id=${userId}`, {
            method: 'POST',
            body: JSON.stringify({ side, password }),
          });
        } catch (err) {
          alert(err.message || 'Bet failed');
          return;
        }
        await loadMarkets();
        await refreshActiveUser();
        await selectMarket(marketId, false);
      }

      async function ensureOddsInSync(marketId) {
        const latest = await fetchJSON(`/markets/${marketId}`);
        const displayed = markets.find((m) => m.id === marketId) || selectedMarket;
        if (displayed) {
          const oddsChanged =
            Math.abs((displayed.price_yes || 0) - (latest.price_yes || 0)) > 0.0001 ||
            Math.abs((displayed.price_no || 0) - (latest.price_no || 0)) > 0.0001;
          if (oddsChanged) {
            alert('The odds changed since your last refresh. Updating the page to prevent mis-priced bets.');
            await refreshData();
            throw new Error('Odds out of sync');
          }
        }
        return latest;
      }

      async function resolveMarket(marketId, outcome) {
        await fetchJSON(`/markets/${marketId}/resolve`, { method: 'POST', body: JSON.stringify({ outcome }) });
        await loadMarkets();
        await refreshActiveUser();
        await selectMarket(marketId, false);
      }

      async function deleteMarket(marketId) {
        const userId = getActiveUserId();
        if (!userId) return alert('Log in to manage markets.');
        if (!confirm('Delete this market and refund everyone?')) return;
        await fetchJSON(`/markets/${marketId}?user_id=${userId}`, { method: 'DELETE' });
        selectedMarket = null;
        await loadMarkets();
        await refreshActiveUser();
      }

      async function complain(marketId) {
        const userId = getActiveUserId();
        if (!userId) return alert('Log in to file a complaint.');
        const reason = prompt('Reason for complaint');
        if (!reason) return;
        await fetchJSON(`/markets/${marketId}/complain?user_id=${userId}`, {
          method: 'POST',
          body: JSON.stringify({ reason }),
        });
        alert('Complaint recorded');
      }

      function getActiveUserId() {
        return activeUserId;
      }

      function setActiveUser(user) {
        if (!user) {
          activeUserId = null;
          activeUserName = '';
          sessionStorage.removeItem('activeUserId');
          sessionStorage.removeItem('activeUserName');
        } else {
          activeUserId = user.id;
          activeUserName = user.name;
          sessionStorage.setItem('activeUserId', String(user.id));
          sessionStorage.setItem('activeUserName', user.name);
        }
        renderSessionHeader();
        refreshActiveUser();
      }

      function updateShareLink() {
        const userId = getActiveUserId();
        const linkContainer = document.getElementById('share-link');
        if (!linkContainer) return;
        if (!userId) {
          linkContainer.textContent = 'Log in to generate a shareable link for this account.';
          return;
        }
        const url = `${window.location.origin}${window.location.pathname}?user_id=${userId}`;
        linkContainer.textContent = `Share this link to reuse the same account on another device: ${url}`;
      }

      function userName(userId) {
        const user = users.find((u) => u.id === userId);
        return user ? user.name : `User ${userId}`;
      }

      async function loadUsers() {
        users = await fetchJSON('/users');
        if (activeUserId && !users.some((u) => u.id === activeUserId)) {
          activeUserId = null;
          activeUserName = '';
        }
        const preferred =
          activeUserId ||
          Number(sessionStorage.getItem('activeUserId') || localStorage.getItem('activeUserId') || initialUserFromQuery || '');
        if (!activeUserId && preferred) {
          const match = users.find((u) => u.id === preferred);
          if (match) {
            activeUserId = match.id;
            activeUserName = match.name;
          }
        }
        renderSessionHeader();
        await refreshActiveUser();
        updateShareLink();
        renderAdminUserSelect();
      }

      async function refreshActiveUser() {
        const userId = getActiveUserId();
        const appShell = document.getElementById('app-shell');
        const logoutBtn = document.getElementById('logout-btn');
        const activeNameEl = document.getElementById('active-user-name');
        const menuNameEl = document.getElementById('menu-user-name');
        const sessionStatus = document.getElementById('session-status');
        const activeCard = document.getElementById('active-account');
        if (!userId) {
          document.getElementById('balance').textContent = '–';
          document.getElementById('positions-count').textContent = '–';
          document.getElementById('ledger').innerHTML = '';
          document.getElementById('positions').innerHTML = '';
          document.getElementById('positions-chip').textContent = '0';
          document.getElementById('balance-chip').textContent = '–';
          selectedMarket = null;
          renderMarketDetail(null);
          renderAdminMarkets();
          updateShareLink();
          if (appShell) appShell.classList.add('hidden');
          if (logoutBtn) logoutBtn.disabled = true;
          if (activeNameEl) activeNameEl.textContent = '–';
          if (menuNameEl) menuNameEl.textContent = '–';
          if (sessionStatus)
            sessionStatus.textContent = adminSession.authenticated
              ? 'Admin session active. User access disabled.'
              : 'Waiting for login.';
          if (activeCard) activeCard.classList.add('hidden');
          renderSessionHeader();
          return;
        }
        const user = await fetchJSON(`/users/${userId}`);
        document.getElementById('balance').textContent = `${user.balance.toFixed(2)} €`;
        document.getElementById('balance-chip').textContent = `${user.balance.toFixed(2)} €`;
        if (activeNameEl) activeNameEl.textContent = user.name;
        if (menuNameEl) menuNameEl.textContent = user.name;
        if (sessionStatus) sessionStatus.textContent = `Logged in as ${user.name}.`;
        if (activeCard) activeCard.classList.remove('hidden');
        await loadLedger(userId);
        await loadPositions(userId);
        renderAdminMarkets();
        sessionStorage.setItem('activeUserId', String(userId));
        sessionStorage.setItem('activeUserName', activeUserName);
        updateShareLink();
        if (appShell) appShell.classList.remove('hidden');
        if (logoutBtn) logoutBtn.disabled = false;
        renderSessionHeader();
      }

      async function loadLedger(userId) {
        const ledger = await fetchJSON(`/users/${userId}/ledger`);
        const container = document.getElementById('ledger');
        container.innerHTML = ledger
          .map(
            (e) =>
              `<div class="list-row"><div class="flex-between"><span class="tag">${e.entry_type}</span><span>${new Date(
                e.created_at,
              ).toLocaleString()}</span></div><div>${e.amount.toFixed(2)} €${e.note ? ` — ${e.note}` : ''}</div></div>`,
          )
          .join('');
      }

      async function loadPositions(userId) {
        const positions = await fetchJSON(`/users/${userId}/positions`);
        document.getElementById('positions-count').textContent = positions.length;
        document.getElementById('positions-chip').textContent = positions.length;
        const container = document.getElementById('positions');
        container.innerHTML = positions
          .map(
            (p) =>
              `<div class="list-row"><div class="flex-between"><strong>${p.market_question}</strong><span class="tag">${p.market_status}</span></div><div>Side: <span class="pill">${p.side}</span></div><div>Shares: ${p.total_shares.toFixed(
                4,
              )} | Stake: ${p.total_stake.toFixed(2)}€ | Avg probability: ${(p.avg_odds * 100).toFixed(
                2,
              )}% | Potential payout: ${p.potential_payout.toFixed(2)}€</div></div>`,
          )
          .join('');
      }

      function marketStatusTag(m) {
        if (m.status === 'RESOLVED') return '<span class="tag success">RESOLVED</span>';
        if (m.status === 'INVALID') return '<span class="tag danger">INVALID</span>';
        return `<span class="tag">${m.status}</span>`;
      }

      function renderOddsChart(history = []) {
        if (!history.length) return '<div class="muted">No price history yet</div>';
        const width = 320;
        const height = 160;
        const padding = 24;
        const points = history.map((h, idx) => ({
          x: (idx / Math.max(history.length - 1, 1)) * (width - padding * 2) + padding,
          y: height - (h.price_yes * (height - padding * 2) + padding),
          prob: h.price_yes,
          ts: h.timestamp,
        }));
        const latest = history[history.length - 1];
        const grid = [0.25, 0.5, 0.75];
        return `
          <div class="chart">
            <div class="flex-between small"><span>YES price</span><span>${(latest.price_yes * 100).toFixed(1)}%</span></div>
            <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}">
              ${grid
                .map(
                  (g) =>
                    `<line x1="${padding}" x2="${width - padding}" y1="${height - (g * (height - padding * 2) + padding)}" y2="${height -
                      (g * (height - padding * 2) + padding)}" stroke="#1f2937" stroke-dasharray="4 4" />`,
                )
                .join('')}
              <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#334155" stroke-width="1" />
              <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#334155" stroke-width="1" />
              <polyline fill="none" stroke="#3b82f6" stroke-width="2" points="${points
                .map((p) => `${p.x},${p.y}`)
                .join(' ')}" />
              ${points
                .map(
                  (p) => `<circle cx="${p.x}" cy="${p.y}" r="2.5" fill="#38bdf8" /> <text x="${p.x + 4}" y="${p.y -
                    4}" class="small" fill="#94a3b8">${(p.prob * 100).toFixed(0)}%</text>`
                )
                .join('')}
              <text x="${width - padding}" y="${height - padding + 16}" text-anchor="end" class="small" fill="#94a3b8">time →</text>
              <text x="${padding - 10}" y="${padding - 8}" text-anchor="end" class="small" fill="#94a3b8">prob</text>
            </svg>
          </div>
        `;
      }

      function renderMarketLedger(market) {
        if (!market.bets || !market.bets.length) return '<div class="muted">No bets yet</div>';
        return market.bets
          .map(
            (b) => `
              <div class="list-row small">
                <div class="flex-between"><span class="pill">${b.side}</span><span>${new Date(b.placed_at).toLocaleString()}</span></div>
                <div>Stake: ${b.cost.toFixed(2)}€ | Shares: ${b.shares.toFixed(4)}</div>
              </div>
            `,
          )
          .join('');
      }

      function renderPayouts(payouts = [], outcome) {
        if (!payouts.length) return '<div class="muted">No payouts yet</div>';
        return payouts
          .map(
            (p) => `
              <div class="list-row small">
                <div class="flex-between"><span class="pill">${p.entry_type}</span><span>${userName(p.user_id)}</span></div>
                <div>${p.amount.toFixed(2)}€${p.note ? ` — ${p.note}` : ''}${outcome ? ` (Outcome: ${outcome})` : ''}</div>
              </div>
            `,
          )
          .join('');
      }

      function formatProbability(p) {
        return `${(p * 100).toFixed(1)}%`;
      }

      function renderOpenMarkets() {
        const container = document.getElementById('open-markets');
        const open = markets.filter((m) => m.status === 'OPEN');
        if (!open.length) {
          container.innerHTML = '<div class="muted">No open markets yet.</div>';
          return;
        }
        const authenticated = isUserAuthenticated();
        container.innerHTML = open
          .map(
            (m) => `
              <div class="market-card">
                <div class="flex-between">
                  <div>
                    <strong>${m.question}</strong>
                    <div class="small">Creator: ${m.creator_name || userName(m.creator_id)}</div>
                  </div>
                  ${marketStatusTag(m)}
                </div>
                <div class="small">YES: ${formatProbability(m.price_yes)} | NO: ${formatProbability(m.price_no)}</div>
                <div class="market-actions">
                  <button onclick="placeBet(${m.id}, 'YES')" ${!authenticated || m.price_yes > 0.95 ? 'disabled' : ''}>
                    Bet 1€ YES<span class="button-sub">${
                      !authenticated
                        ? 'Log in to place bets'
                        : m.price_yes > 0.95
                        ? 'Locked above 95% YES'
                        : `Win ${m.yes_preview.payout.toFixed(2)}€`
                    }</span>
                  </button>
                  <button onclick="placeBet(${m.id}, 'NO')" ${!authenticated || m.price_yes < 0.05 ? 'disabled' : ''}>
                    Bet 1€ NO<span class="button-sub">${
                      !authenticated
                        ? 'Log in to place bets'
                        : m.price_yes < 0.05
                        ? 'Locked below 5% YES'
                        : `Win ${m.no_preview.payout.toFixed(2)}€`
                    }</span>
                  </button>
                  <button class="secondary" onclick="selectMarket(${m.id})">View details</button>
                </div>
              </div>
            `,
          )
          .join('');
      }

      async function selectMarket(id, focusTab = true) {
        if (focusTab) switchTab('open');
        selectedMarket = await fetchJSON(`/markets/${id}`);
        renderMarketDetail(selectedMarket);
      }

      function renderMarketDetail(market) {
        const container = document.getElementById('market-detail');
        if (!market) {
          container.innerHTML = '<div class="muted">Select a market to see details</div>';
          return;
        }
        const activeUserId = getActiveUserId();
        const authenticated = isUserAuthenticated(activeUserId);
        const canResolve = market.status !== 'RESOLVED' && market.status !== 'INVALID';
        const adminControls =
          activeUserId && Number(activeUserId) === market.creator_id && canResolve
            ? `
                <button class="secondary" onclick="resolveMarket(${market.id}, 'YES')">Resolve YES</button>
                <button class="secondary" onclick="resolveMarket(${market.id}, 'NO')">Resolve NO</button>
                <button class="secondary" onclick="resolveMarket(${market.id}, 'INVALID')">Invalidate</button>
                <button class="secondary" onclick="deleteMarket(${market.id})">Delete & clear</button>
              `
            : '';
        const yesLocked = market.price_yes > 0.95;
        const noLocked = market.price_yes < 0.05;
        const canBet = market.status === 'OPEN';
        const canPlaceBets = canBet && authenticated;
        const betButtons = canBet
          ? `
              <button onclick="placeBet(${market.id}, 'YES')" ${!canPlaceBets || yesLocked ? 'disabled' : ''}>Bet 1€ YES<span class="button-sub">${
                !authenticated
                  ? 'Log in to place bets'
                  : yesLocked
                  ? 'Locked above 95% YES'
                  : `Win ${market.yes_preview.payout.toFixed(2)}€`
              }</span></button>
              <button onclick="placeBet(${market.id}, 'NO')" ${!canPlaceBets || noLocked ? 'disabled' : ''}>Bet 1€ NO<span class="button-sub">${
                !authenticated
                  ? 'Log in to place bets'
                  : noLocked
                  ? 'Locked below 5% YES'
                  : `Win ${market.no_preview.payout.toFixed(2)}€`
              }</span></button>
            `
          : '<div class="muted">Betting is closed for this market.</div>';
        const resolutionPanel =
          market.status === 'RESOLVED' || market.status === 'INVALID'
            ? `
                <div class="panel">
                  <div class="label">Resolution breakdown</div>
                  <div>Total pot: ${market.total_pot.toFixed(2)}€</div>
                  <div>Creator settlement: ${market.creator_payout.toFixed(2)}€</div>
                  <div>Winning payout: ${(market.total_payout_yes + market.total_payout_no).toFixed(2)}€</div>
                  <h4>Payouts</h4>
                  <div class="ledger-list">${renderPayouts(market.payouts, market.outcome)}</div>
                </div>
              `
            : '';
        container.innerHTML = `
          <div class="market-card">
            <div class="flex-between">
              <div>
                <strong>${market.question}</strong>
                <div class="small">${market.description || ''}</div>
                <div class="small">Resolution source: ${market.resolution_source || '–'}</div>
                <div class="small">Created by: ${market.creator_name || userName(market.creator_id)}</div>
              </div>
              ${marketStatusTag(market)}
            </div>
            <div class="metrics">
              <div class="metric"><div class="label">YES probability</div><div class="value">${formatProbability(market.price_yes)}</div></div>
              <div class="metric"><div class="label">NO probability</div><div class="value">${formatProbability(market.price_no)}</div></div>
              <div class="metric"><div class="label">Created by</div><div class="value">${userName(market.creator_id)}</div></div>
              <div class="metric"><div class="label">Liquidity b</div><div class="value">${market.liquidity_b}</div></div>
            </div>
            <div class="detail-grid">
              <div class="panel">
                <div class="label">1€ bet preview</div>
                <div>YES: payout ${market.yes_preview.payout.toFixed(4)}€</div>
                <div>NO: payout ${market.no_preview.payout.toFixed(4)}€</div>
              </div>
              <div class="panel">
                <div class="label">Volume</div>
                <div class="value">YES: ${market.volume_yes.toFixed(2)}€ | NO: ${market.volume_no.toFixed(2)}€ | Total: ${(market.volume_yes +
          market.volume_no).toFixed(2)}€</div>
              </div>
            </div>
            ${renderOddsChart(market.odds_history)}
            ${resolutionPanel}
            <div class="market-actions">
              ${betButtons}
              ${adminControls}
              <button class="secondary" onclick="complain(${market.id})">Complain</button>
            </div>
            <div class="ledger-list">${renderMarketLedger(market)}</div>
          </div>
        `;
      }

      function renderAdminMarkets() {
        const container = document.getElementById('admin-markets');
        const activeUserId = getActiveUserId();
        if (!activeUserId) {
          container.innerHTML = '<div class="muted">Log in to see the markets you created.</div>';
          return;
        }
        const mine = markets.filter((m) => m.creator_id === Number(activeUserId));
        if (!mine.length) {
          container.innerHTML = '<div class="muted">No markets created yet.</div>';
          return;
        }
        container.innerHTML = mine
          .map(
            (m) => `
              <div class="market-card">
                <div class="flex-between">
                  <div><strong>${m.question}</strong><div class="small">${m.description || ''}</div></div>
                  ${marketStatusTag(m)}
                </div>
                <div class="small">YES: ${formatProbability(m.price_yes)} | NO: ${formatProbability(m.price_no)}</div>
                <div class="market-actions">
                  <button class="secondary" onclick="selectMarket(${m.id})">View</button>
                  ${(() => {
                    const canResolve = m.status !== 'RESOLVED' && m.status !== 'INVALID';
                    return canResolve
                      ? `
                          <button class="secondary" onclick="resolveMarket(${m.id}, 'YES')">Resolve YES</button>
                          <button class="secondary" onclick="resolveMarket(${m.id}, 'NO')">Resolve NO</button>
                          <button class="secondary" onclick="resolveMarket(${m.id}, 'INVALID')">Invalidate</button>
                        `
                      : '<span class="muted">Resolution complete</span>';
                  })()}
                  <button class="secondary" onclick="deleteMarket(${m.id})">Delete & clear</button>
                </div>
              </div>
            `,
          )
          .join('');
      }

      async function loadMarkets() {
        markets = await fetchJSON('/markets');
        renderOpenMarkets();
        renderAdminMarkets();
        if (selectedMarket) {
          const stillExists = markets.some((m) => m.id === selectedMarket.id);
          if (stillExists) {
            await selectMarket(selectedMarket.id, false);
          } else {
            selectedMarket = null;
            renderMarketDetail(null);
          }
        } else {
          renderMarketDetail(null);
        }
      }

      async function init() {
        renderSessionHeader();
        updateAdminStatus();
        updateBackendInput();
        renderAdminDirectory();
        await refreshData();
      }

      async function refreshData() {
        await loadUsers();
        await loadMarkets();
        if (adminSession.authenticated) await loadAdminDirectory();
      }

      init();
    </script>
  </body>
</html>
