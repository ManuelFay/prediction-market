<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Friends Prediction Market</title>
    <style>
      :root {
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #0b1021;
        color: #e2e8f0;
      }
      body {
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.08), transparent 30%),
          radial-gradient(circle at bottom right, rgba(16, 185, 129, 0.08), transparent 25%),
          #0b1021;
      }
      header {
        background: #0f172a;
        padding: 18px 24px;
        border-bottom: 1px solid #1f2937;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        position: sticky;
        top: 0;
        z-index: 10;
      }
      h1 {
        margin: 0;
        font-size: 22px;
      }
      main {
        padding: 20px 24px 32px;
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 16px;
        align-items: start;
      }
      section {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid #1f2937;
        border-radius: 14px;
        padding: 16px;
        backdrop-filter: blur(4px);
      }
      h2 {
        margin-top: 0;
        font-size: 18px;
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }
      input,
      select,
      textarea,
      button {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 10px;
        border: 1px solid #1f2937;
        background: #0b1221;
        color: #e2e8f0;
        box-sizing: border-box;
      }
      button {
        cursor: pointer;
        background: linear-gradient(90deg, #14b8a6, #3b82f6);
        border: none;
        font-weight: 700;
        transition: transform 0.08s ease, box-shadow 0.08s ease;
        text-align: left;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.25);
      }
      button.secondary {
        background: #111827;
        border: 1px solid #334155;
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 8px;
        margin-bottom: 10px;
      }
      .metric {
        background: #0b1221;
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 10px;
      }
      .metric .label {
        color: #94a3b8;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .metric .value {
        font-size: 18px;
        font-weight: 700;
      }
      .market-card {
        display: grid;
        gap: 8px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #1f2937;
        background: #0b1221;
        margin-bottom: 12px;
      }
      .market-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
      }
      .bets-list,
      .ledger-list {
        max-height: 260px;
        overflow: auto;
        border: 1px solid #1f2937;
        border-radius: 10px;
      }
      .list-row {
        border-bottom: 1px solid #1f2937;
        padding: 8px 10px;
      }
      .list-row:last-child {
        border-bottom: none;
      }
      .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        background: #1f2937;
        border: 1px solid #334155;
        margin-right: 6px;
      }
      .pill {
        padding: 2px 8px;
        border-radius: 8px;
        background: #1e3a8a;
        display: inline-block;
      }
      .danger {
        background: #7f1d1d;
        border: 1px solid #dc2626;
      }
      .success {
        background: #064e3b;
        border: 1px solid #10b981;
      }
      .button-sub {
        display: block;
        font-weight: 500;
        font-size: 12px;
        opacity: 0.9;
      }
      .small {
        font-size: 12px;
        color: #94a3b8;
      }
      .flex {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .flex-between {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .chart {
        background: #0b1221;
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 10px;
      }
      .warning {
        background: #3f1f1f;
        border: 1px solid #7f1d1d;
        padding: 8px 10px;
        border-radius: 8px;
        color: #fecaca;
      }
      .muted {
        color: #94a3b8;
        font-size: 12px;
      }
      .tab-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px;
        margin-bottom: 8px;
      }
      .tab-button {
        background: #111827;
        border: 1px solid #1f2937;
        color: #e2e8f0;
      }
      .tab-button.active {
        background: linear-gradient(90deg, #0ea5e9, #6366f1);
        border-color: #1d4ed8;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .detail-grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      .panel {
        border: 1px solid #1f2937;
        background: #0c1326;
        border-radius: 12px;
        padding: 12px;
      }
      .inline-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .inline-group > input,
      .inline-group > button {
        width: auto;
        flex: 1;
      }
      .inline-group > button {
        flex: 0 0 auto;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Friends-only Prediction Market</h1>
    </header>
    <main>
      <section>
        <h2>Accounts</h2>
        <h3>Backend connection</h3>
        <label for="backend-url">Backend URL</label>
        <input id="backend-url" placeholder="https://my-market.example.com" />
        <div class="inline-group">
          <button class="secondary" onclick="applyBackendUrl()">Connect to backend</button>
          <button class="secondary" onclick="refreshData()">Refresh data</button>
        </div>
        <hr />
        <label for="new-user-name">New user name</label>
        <input id="new-user-name" placeholder="Alice" />
        <button onclick="createUser()">Create user (starts with 50€)</button>
        <button class="secondary" onclick="resetPlatform()">Reset platform (delete all users)</button>
        <hr />
        <h3>Account sync</h3>
        <label for="existing-user-id">Load existing user by ID</label>
        <div class="inline-group">
          <input id="existing-user-id" type="number" min="1" placeholder="123" />
          <button class="secondary" onclick="useExistingUser()">Set active user</button>
        </div>
        <div class="muted" id="share-link"></div>
        <hr />
        <label for="active-user">Active user</label>
        <select id="active-user" onchange="refreshActiveUser()"></select>
        <div class="metrics">
          <div class="metric">
            <div class="label">Balance</div>
            <div class="value" id="balance">–</div>
          </div>
          <div class="metric">
            <div class="label">Positions</div>
            <div class="value" id="positions-count">–</div>
          </div>
        </div>
        <label for="topup-amount">Top-up amount (€)</label>
        <input id="topup-amount" type="number" step="1" value="10" />
        <button onclick="deposit()" class="secondary">Top up account</button>
        <hr />
        <h3>Open positions</h3>
        <div class="bets-list" id="positions"></div>
        <h3>Ledger</h3>
        <div class="ledger-list" id="ledger"></div>
      </section>
      <section>
        <div class="tab-bar">
          <button class="tab-button active" id="tab-create-btn" onclick="switchTab('create')">Create new market</button>
          <button class="tab-button" id="tab-open-btn" onclick="switchTab('open')">Open markets</button>
          <button class="tab-button" id="tab-admin-btn" onclick="switchTab('admin')">Market admin</button>
        </div>
        <div id="tab-create" class="tab-content active">
          <h2>Create market</h2>
          <div class="flex-between small"><span>Seed: 10€ will be locked from creator.</span><span>Bet size: fixed 1€</span></div>
          <label for="question">Question</label>
          <input id="question" placeholder="YES if PSG beats OM?" />
          <label for="description">Details</label>
          <textarea id="description" placeholder="Resolution rules, notes"></textarea>
          <label for="initial-prob">Initial probability for YES (0-1)</label>
          <input id="initial-prob" type="number" step="0.01" value="0.5" />
          <label for="liquidity-b">Liquidity b (controls slippage)</label>
          <input id="liquidity-b" type="number" step="0.5" value="5" />
          <button onclick="createMarket()">Create market</button>
        </div>
        <div id="tab-open" class="tab-content">
          <h2>Open markets</h2>
          <div id="open-markets"></div>
          <div id="market-detail" class="panel"></div>
        </div>
        <div id="tab-admin" class="tab-content">
          <h2>Market admin</h2>
          <div class="muted">Manage the markets you created. You can resolve, delete or open their details.</div>
          <div id="admin-markets"></div>
        </div>
      </section>
    </main>
    <script>
      const storedBackend = localStorage.getItem('apiBase');
      let apiBase = (storedBackend || window.location.origin).replace(/\/$/, '');
      let users = [];
      let markets = [];
      let selectedMarket = null;
      const initialUserFromQuery = Number(new URLSearchParams(window.location.search).get('user_id') || '');

      function applyBackendUrl() {
        const input = document.getElementById('backend-url');
        const value = (input.value || '').trim().replace(/\/$/, '');
        if (!value) return alert('Enter a backend URL');
        apiBase = value;
        localStorage.setItem('apiBase', apiBase);
        refreshData();
      }

      function updateBackendInput() {
        const input = document.getElementById('backend-url');
        if (input) input.value = apiBase;
      }

      function switchTab(tab) {
        document.querySelectorAll('.tab-button').forEach((btn) => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));
        document.getElementById(`tab-${tab}-btn`).classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
      }

      async function fetchJSON(path, options = {}) {
        const res = await fetch(`${apiBase}${path}`, {
          headers: { 'Content-Type': 'application/json' },
          ...options,
        });
        if (!res.ok) {
          const error = await res.json().catch(() => ({}));
          throw new Error(error.detail || 'Request failed');
        }
        if (res.status === 204) return {};
        return res.json();
      }

      async function createUser() {
        const name = document.getElementById('new-user-name').value.trim();
        if (!name) return alert('Enter a name');
        await fetchJSON('/users', { method: 'POST', body: JSON.stringify({ name }) });
        document.getElementById('new-user-name').value = '';
        await loadUsers();
      }

      async function resetPlatform() {
        if (!confirm('This will delete all users, markets, and bets. Continue?')) return;
        await fetchJSON('/reset', { method: 'POST' });
        document.getElementById('balance').textContent = '–';
        document.getElementById('positions-count').textContent = '–';
        document.getElementById('ledger').innerHTML = '';
        document.getElementById('positions').innerHTML = '';
        selectedMarket = null;
        await loadUsers();
        await loadMarkets();
      }

      async function deposit() {
        const userId = getActiveUserId();
        if (!userId) return;
        const amount = Number(document.getElementById('topup-amount').value || '0');
        if (amount <= 0) return alert('Enter a positive amount');
        await fetchJSON(`/users/${userId}/deposit`, { method: 'POST', body: JSON.stringify({ amount }) });
        await refreshActiveUser();
      }

      async function createMarket() {
        const userId = getActiveUserId();
        if (!userId) return alert('Pick a creator');
        const payload = {
          question: document.getElementById('question').value,
          description: document.getElementById('description').value,
          initial_prob_yes: Number(document.getElementById('initial-prob').value),
          liquidity_b: Number(document.getElementById('liquidity-b').value),
        };
        await fetchJSON(`/markets?user_id=${userId}`, { method: 'POST', body: JSON.stringify(payload) });
        document.getElementById('question').value = '';
        document.getElementById('description').value = '';
        await loadMarkets();
        await refreshActiveUser();
        switchTab('open');
      }

      async function placeBet(marketId, side) {
        const userId = getActiveUserId();
        if (!userId) return alert('Pick a user to bet');
        try {
          await ensureOddsInSync(marketId);
          await fetchJSON(`/markets/${marketId}/bet?user_id=${userId}`, {
            method: 'POST',
            body: JSON.stringify({ side }),
          });
        } catch (err) {
          alert(err.message || 'Bet failed');
          return;
        }
        await loadMarkets();
        await refreshActiveUser();
        await selectMarket(marketId, false);
      }

      async function ensureOddsInSync(marketId) {
        const latest = await fetchJSON(`/markets/${marketId}`);
        const displayed = markets.find((m) => m.id === marketId) || selectedMarket;
        if (displayed) {
          const oddsChanged =
            Math.abs((displayed.price_yes || 0) - (latest.price_yes || 0)) > 0.0001 ||
            Math.abs((displayed.price_no || 0) - (latest.price_no || 0)) > 0.0001;
          if (oddsChanged) {
            alert('The odds changed since your last refresh. Updating the page to prevent mis-priced bets.');
            await refreshData();
            throw new Error('Odds out of sync');
          }
        }
        return latest;
      }

      async function resolveMarket(marketId, outcome) {
        await fetchJSON(`/markets/${marketId}/resolve`, { method: 'POST', body: JSON.stringify({ outcome }) });
        await loadMarkets();
        await refreshActiveUser();
        await selectMarket(marketId, false);
      }

      async function deleteMarket(marketId) {
        const userId = getActiveUserId();
        if (!userId) return alert('Pick a user to manage markets');
        if (!confirm('Delete this market and refund everyone?')) return;
        await fetchJSON(`/markets/${marketId}?user_id=${userId}`, { method: 'DELETE' });
        selectedMarket = null;
        await loadMarkets();
        await refreshActiveUser();
      }

      async function complain(marketId) {
        const userId = getActiveUserId();
        if (!userId) return alert('Pick a user to complain');
        const reason = prompt('Reason for complaint');
        if (!reason) return;
        await fetchJSON(`/markets/${marketId}/complain?user_id=${userId}`, {
          method: 'POST',
          body: JSON.stringify({ reason }),
        });
        alert('Complaint recorded');
      }

      function getActiveUserId() {
        const select = document.getElementById('active-user');
        return select.value ? Number(select.value) : null;
      }

      function setActiveUserId(userId) {
        const select = document.getElementById('active-user');
        if (!select) return;
        select.value = userId;
        refreshActiveUser();
      }

      function updateShareLink() {
        const userId = getActiveUserId();
        const linkContainer = document.getElementById('share-link');
        if (!linkContainer) return;
        if (!userId) {
          linkContainer.textContent = 'Pick a user to generate a shareable link.';
          return;
        }
        const url = `${window.location.origin}${window.location.pathname}?user_id=${userId}`;
        linkContainer.textContent = `Share this link to reuse the same account on another device: ${url}`;
      }

      function userName(userId) {
        const user = users.find((u) => u.id === userId);
        return user ? user.name : `User ${userId}`;
      }

      async function loadUsers() {
        const current = getActiveUserId();
        const preferred = current || Number(localStorage.getItem('activeUserId') || initialUserFromQuery || '');
        users = await fetchJSON('/users');
        const select = document.getElementById('active-user');
        select.innerHTML = '<option value="">Select user</option>';
        users.forEach((u) => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = `${u.name} (balance ${u.balance.toFixed(2)}€)`;
          select.appendChild(opt);
        });
        if (current && users.some((u) => u.id === current)) {
          select.value = current;
        } else if (preferred && users.some((u) => u.id === preferred)) {
          select.value = preferred;
        } else if (!select.value && users.length) {
          select.value = users[0].id;
        }
        await refreshActiveUser();
        updateShareLink();
      }

      async function refreshActiveUser() {
        const userId = getActiveUserId();
        if (!userId) return;
        const user = await fetchJSON(`/users/${userId}`);
        document.getElementById('balance').textContent = `${user.balance.toFixed(2)} €`;
        await loadLedger(userId);
        await loadPositions(userId);
        renderAdminMarkets();
        localStorage.setItem('activeUserId', String(userId));
        updateShareLink();
      }

      async function useExistingUser() {
        const input = document.getElementById('existing-user-id');
        const userId = Number((input.value || '').trim());
        if (!userId) return alert('Enter a valid user ID');
        try {
          const user = await fetchJSON(`/users/${userId}`);
          if (!users.some((u) => u.id === user.id)) {
            users.push(user);
          }
          setActiveUserId(user.id);
        } catch (err) {
          alert('Could not load that user. Make sure the ID exists on this backend.');
        }
      }

      async function loadLedger(userId) {
        const ledger = await fetchJSON(`/users/${userId}/ledger`);
        const container = document.getElementById('ledger');
        container.innerHTML = ledger
          .map(
            (e) =>
              `<div class="list-row"><div class="flex-between"><span class="tag">${e.entry_type}</span><span>${new Date(
                e.created_at,
              ).toLocaleString()}</span></div><div>${e.amount.toFixed(2)} €${e.note ? ` — ${e.note}` : ''}</div></div>`,
          )
          .join('');
      }

      async function loadPositions(userId) {
        const positions = await fetchJSON(`/users/${userId}/positions`);
        document.getElementById('positions-count').textContent = positions.length;
        const container = document.getElementById('positions');
        container.innerHTML = positions
          .map(
            (p) =>
              `<div class="list-row"><div class="flex-between"><strong>${p.market_question}</strong><span class="tag">${p.market_status}</span></div><div>Side: <span class="pill">${p.side}</span></div><div>Shares: ${p.total_shares.toFixed(
                4,
              )} | Stake: ${p.total_stake.toFixed(2)}€ | Avg probability: ${(p.avg_odds * 100).toFixed(
                2,
              )}% | Potential payout: ${p.potential_payout.toFixed(2)}€</div></div>`,
          )
          .join('');
      }

      function marketStatusTag(m) {
        if (m.status === 'RESOLVED') return '<span class="tag success">RESOLVED</span>';
        if (m.status === 'INVALID') return '<span class="tag danger">INVALID</span>';
        return `<span class="tag">${m.status}</span>`;
      }

      function renderOddsChart(history = []) {
        if (!history.length) return '<div class="muted">No price history yet</div>';
        const width = 320;
        const height = 160;
        const padding = 24;
        const points = history.map((h, idx) => ({
          x: (idx / Math.max(history.length - 1, 1)) * (width - padding * 2) + padding,
          y: height - (h.price_yes * (height - padding * 2) + padding),
          prob: h.price_yes,
          ts: h.timestamp,
        }));
        const latest = history[history.length - 1];
        const grid = [0.25, 0.5, 0.75];
        return `
          <div class="chart">
            <div class="flex-between small"><span>YES price</span><span>${(latest.price_yes * 100).toFixed(1)}%</span></div>
            <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}">
              ${grid
                .map(
                  (g) =>
                    `<line x1="${padding}" x2="${width - padding}" y1="${height - (g * (height - padding * 2) + padding)}" y2="${height -
                      (g * (height - padding * 2) + padding)}" stroke="#1f2937" stroke-dasharray="4 4" />`,
                )
                .join('')}
              <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#334155" stroke-width="1" />
              <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#334155" stroke-width="1" />
              <polyline fill="none" stroke="#3b82f6" stroke-width="2" points="${points
                .map((p) => `${p.x},${p.y}`)
                .join(' ')}" />
              ${points
                .map(
                  (p) => `<circle cx="${p.x}" cy="${p.y}" r="2.5" fill="#38bdf8" /> <text x="${p.x + 4}" y="${p.y -
                    4}" class="small" fill="#94a3b8">${(p.prob * 100).toFixed(0)}%</text>`
                )
                .join('')}
              <text x="${width - padding}" y="${height - padding + 16}" text-anchor="end" class="small" fill="#94a3b8">time →</text>
              <text x="${padding - 10}" y="${padding - 8}" text-anchor="end" class="small" fill="#94a3b8">prob</text>
            </svg>
          </div>
        `;
      }

      function renderMarketLedger(market) {
        if (!market.bets || !market.bets.length) return '<div class="muted">No bets yet</div>';
        return market.bets
          .map(
            (b) => `
              <div class="list-row small">
                <div class="flex-between"><span class="pill">${b.side}</span><span>${new Date(b.placed_at).toLocaleString()}</span></div>
                <div>Stake: ${b.cost.toFixed(2)}€ | Shares: ${b.shares.toFixed(4)}</div>
              </div>
            `,
          )
          .join('');
      }

      function renderPayouts(payouts = [], outcome) {
        if (!payouts.length) return '<div class="muted">No payouts yet</div>';
        return payouts
          .map(
            (p) => `
              <div class="list-row small">
                <div class="flex-between"><span class="pill">${p.entry_type}</span><span>${userName(p.user_id)}</span></div>
                <div>${p.amount.toFixed(2)}€${p.note ? ` — ${p.note}` : ''}${outcome ? ` (Outcome: ${outcome})` : ''}</div>
              </div>
            `,
          )
          .join('');
      }

      function formatProbability(p) {
        return `${(p * 100).toFixed(1)}%`;
      }

      function renderOpenMarkets() {
        const container = document.getElementById('open-markets');
        const open = markets.filter((m) => m.status === 'OPEN');
        if (!open.length) {
          container.innerHTML = '<div class="muted">No open markets yet.</div>';
          document.getElementById('market-detail').innerHTML = '';
          return;
        }
        container.innerHTML = open
          .map(
            (m) => `
              <div class="market-card">
                <div class="flex-between">
                  <div><strong>${m.question}</strong><div class="small">${m.description || ''}</div></div>
                  ${marketStatusTag(m)}
                </div>
                <div class="metrics">
                  <div class="metric"><div class="label">YES prob</div><div class="value">${formatProbability(m.price_yes)}</div></div>
                  <div class="metric"><div class="label">NO prob</div><div class="value">${formatProbability(m.price_no)}</div></div>
                </div>
                <div class="small">1€ bet preview → YES wins: ${m.yes_preview.payout.toFixed(3)}€ | NO wins: ${m.no_preview.payout.toFixed(3)}€</div>
                <div class="market-actions">
                  <button onclick="placeBet(${m.id}, 'YES')" ${m.price_yes > 0.95 ? 'disabled' : ''}>
                    Bet 1€ YES<span class="button-sub">${m.price_yes > 0.95 ? 'Locked above 95% YES' : `Win ${m.yes_preview.payout.toFixed(2)}€`}</span>
                  </button>
                  <button onclick="placeBet(${m.id}, 'NO')" ${m.price_yes < 0.05 ? 'disabled' : ''}>
                    Bet 1€ NO<span class="button-sub">${m.price_yes < 0.05 ? 'Locked below 5% YES' : `Win ${m.no_preview.payout.toFixed(2)}€`}</span>
                  </button>
                  <button class="secondary" onclick="selectMarket(${m.id})">View details</button>
                </div>
              </div>
            `,
          )
          .join('');
      }

      async function selectMarket(id, focusTab = true) {
        if (focusTab) switchTab('open');
        selectedMarket = await fetchJSON(`/markets/${id}`);
        renderMarketDetail(selectedMarket);
      }

      function renderMarketDetail(market) {
        const container = document.getElementById('market-detail');
        if (!market) {
          container.innerHTML = '<div class="muted">Select a market to see details</div>';
          return;
        }
        const activeUserId = getActiveUserId();
        const canResolve = market.status !== 'RESOLVED' && market.status !== 'INVALID';
        const adminControls =
          activeUserId && Number(activeUserId) === market.creator_id && canResolve
            ? `
                <button class="secondary" onclick="resolveMarket(${market.id}, 'YES')">Resolve YES</button>
                <button class="secondary" onclick="resolveMarket(${market.id}, 'NO')">Resolve NO</button>
                <button class="secondary" onclick="resolveMarket(${market.id}, 'INVALID')">Invalidate</button>
                <button class="secondary" onclick="deleteMarket(${market.id})">Delete & clear</button>
              `
            : '';
        const yesLocked = market.price_yes > 0.95;
        const noLocked = market.price_yes < 0.05;
        const canBet = market.status === 'OPEN';
        const betButtons = canBet
          ? `
              <button onclick="placeBet(${market.id}, 'YES')" ${yesLocked ? 'disabled' : ''}>Bet 1€ YES<span class="button-sub">${yesLocked ? 'Locked above 95% YES' : `Win ${market.yes_preview.payout.toFixed(2)}€`}</span></button>
              <button onclick="placeBet(${market.id}, 'NO')" ${noLocked ? 'disabled' : ''}>Bet 1€ NO<span class="button-sub">${noLocked ? 'Locked below 5% YES' : `Win ${market.no_preview.payout.toFixed(2)}€`}</span></button>
            `
          : '<div class="muted">Betting is closed for this market.</div>';
        const resolutionPanel =
          market.status === 'RESOLVED' || market.status === 'INVALID'
            ? `
                <div class="panel">
                  <div class="label">Resolution breakdown</div>
                  <div>Total pot: ${market.total_pot.toFixed(2)}€</div>
                  <div>Creator settlement: ${market.creator_payout.toFixed(2)}€</div>
                  <div>Winning payout: ${(market.total_payout_yes + market.total_payout_no).toFixed(2)}€</div>
                  <h4>Payouts</h4>
                  <div class="ledger-list">${renderPayouts(market.payouts, market.outcome)}</div>
                </div>
              `
            : '';
        container.innerHTML = `
          <div class="market-card">
            <div class="flex-between">
              <div>
                <strong>${market.question}</strong>
                <div class="small">${market.description || ''}</div>
                <div class="small">Resolution source: ${market.resolution_source || '–'}</div>
              </div>
              ${marketStatusTag(market)}
            </div>
            <div class="metrics">
              <div class="metric"><div class="label">YES probability</div><div class="value">${formatProbability(market.price_yes)}</div></div>
              <div class="metric"><div class="label">NO probability</div><div class="value">${formatProbability(market.price_no)}</div></div>
              <div class="metric"><div class="label">Created by</div><div class="value">${userName(market.creator_id)}</div></div>
              <div class="metric"><div class="label">Liquidity b</div><div class="value">${market.liquidity_b}</div></div>
            </div>
            <div class="detail-grid">
              <div class="panel">
                <div class="label">1€ bet preview</div>
                <div>YES: payout ${market.yes_preview.payout.toFixed(4)}€</div>
                <div>NO: payout ${market.no_preview.payout.toFixed(4)}€</div>
              </div>
              <div class="panel">
                <div class="label">Volume</div>
                <div class="value">YES: ${market.volume_yes.toFixed(2)}€ | NO: ${market.volume_no.toFixed(2)}€ | Total: ${(market.volume_yes +
          market.volume_no).toFixed(2)}€</div>
              </div>
            </div>
            ${renderOddsChart(market.odds_history)}
            ${resolutionPanel}
            <div class="market-actions">
              ${betButtons}
              ${adminControls}
              <button class="secondary" onclick="complain(${market.id})">Complain</button>
            </div>
            <div class="ledger-list">${renderMarketLedger(market)}</div>
          </div>
        `;
      }

      function renderAdminMarkets() {
        const container = document.getElementById('admin-markets');
        const activeUserId = getActiveUserId();
        if (!activeUserId) {
          container.innerHTML = '<div class="muted">Select a user to see their markets.</div>';
          return;
        }
        const mine = markets.filter((m) => m.creator_id === Number(activeUserId));
        if (!mine.length) {
          container.innerHTML = '<div class="muted">No markets created yet.</div>';
          return;
        }
        container.innerHTML = mine
          .map(
            (m) => `
              <div class="market-card">
                <div class="flex-between">
                  <div><strong>${m.question}</strong><div class="small">${m.description || ''}</div></div>
                  ${marketStatusTag(m)}
                </div>
                <div class="small">YES: ${formatProbability(m.price_yes)} | NO: ${formatProbability(m.price_no)}</div>
                <div class="market-actions">
                  <button class="secondary" onclick="selectMarket(${m.id})">View</button>
                  ${(() => {
                    const canResolve = m.status !== 'RESOLVED' && m.status !== 'INVALID';
                    return canResolve
                      ? `
                          <button class="secondary" onclick="resolveMarket(${m.id}, 'YES')">Resolve YES</button>
                          <button class="secondary" onclick="resolveMarket(${m.id}, 'NO')">Resolve NO</button>
                          <button class="secondary" onclick="resolveMarket(${m.id}, 'INVALID')">Invalidate</button>
                        `
                      : '<span class="muted">Resolution complete</span>';
                  })()}
                  <button class="secondary" onclick="deleteMarket(${m.id})">Delete & clear</button>
                </div>
              </div>
            `,
          )
          .join('');
      }

      async function loadMarkets() {
        markets = await fetchJSON('/markets');
        renderOpenMarkets();
        renderAdminMarkets();
        if (selectedMarket) {
          await selectMarket(selectedMarket.id, false);
        } else if (markets.length) {
          const firstOpen = markets.find((m) => m.status === 'OPEN') || markets[0];
          await selectMarket(firstOpen.id, false);
        }
      }

      async function init() {
        updateBackendInput();
        await refreshData();
      }

      async function refreshData() {
        await loadUsers();
        await loadMarkets();
      }

      init();
    </script>
  </body>
</html>
